<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-fit-behavior/iron-fit-behavior.html">
<link rel="import" href="../../bower_components/iron-a11y-announcer/iron-a11y-announcer.html">
<link rel="import" href="../../bower_components/iron-overlay-behavior/iron-overlay-behavior.html">
<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">

<!--
    @author Robin Duda
    Polymer element for use as a login box.
 -->

<dom-module id="game-login">
    <link rel="import" href="../../style/theme.css" type="css">
    <link rel="import" href="../../style/style.css" type="css">
    <template>
        <style>
            :host {
                display: block;
            }

            .title {
                text-align: center;
                padding-top: 16px;
            }

            .container {
                margin: 326px auto auto;
                width: 525px;
                min-width: 326px;
                height: 186px;
            }

            @media (max-width: 525px) {
                .container {
                    width: 96%;
                    margin: auto;
                }
            }

            .register {
                margin-top: 32px;
            }
        </style>

        <div class="container center-box" id="container">
            <paper-material elevation="3">
                <div class="title">
                    <h4>{{title}}</h4>
                </div>

                <paper-input value="{{username}}" id="username" label="Username" on-keydown="submit"
                             autofocus></paper-input>
                <paper-input value="{{password}}" id="password" label="Password" on-keydown="submit"
                             type="password"></paper-input>

                <div hidden$="{{hideregisterform}}">
                    <paper-input value="{{password-repeat}}" label="Password (repeat)" type="password"
                                 on-keydown="submit" id="password-repeat"></paper-input>
                    <paper-input value="{{email}}" label="Email (optional)" on-keydown="submit"></paper-input>

                    <paper-button class="register flex" on-tap="showLoginForm">Back</paper-button>
                    <paper-button raised class="primary flex" on-tap="register">Register</paper-button>
                </div>

                <div hidden$="{{hideloginform}}">
                    <paper-button class="register flex" on-tap="showRegisterForm">Register</paper-button>
                    <paper-button raised class="primary flex" on-tap="authenticate">Authenticate</paper-button>
                </div>

            </paper-material>

            <paper-toast class="fit-bottom" id="loginToast" text="{{toasttext}}"></paper-toast>
        </div>

        </div>

    </template>
</dom-module>

<script>
    class GameLogin extends Polymer.Element {

        static get is() {
            return 'game-login';
        }

        ready() {
            super.ready();
            this.authentication = new Authentication();
            this.showLoginForm();
        }

        authenticate(e) {
            this.showToast('Authenticating..');

            this.authentication.login({
                accepted: (data) => {
                    this.showToast('Loading..');
                    this.resetForm();
                    application.authenticated(data);
                },
                unauthorized: (data) => {
                    this.showToast('Invalid user credentials');
                    this.password = "";
                    this.$['password'].focus();
                },
                missing: (data) => {
                    this.showToast('The specified username does not exist');
                    this.showRegisterForm();
                    this.$['password-repeat'].focus();
                },
                error: (e) => {
                    this.showToast(e.message);
                },
                failed: () => {
                    application.error('Failed to establish a connection to the authentication server.')
                }
            }, this.username, this.password);
        }

        register(e) {
            if (this.password === this['password-repeat']) {
                this.showToast('Registering..');
                this.authentication.register({
                    accepted: (data) => {
                        this.showToast('Loading..');
                        this.resetForm();
                        application.authenticated(data);
                    },
                    bad: (data) => {
                        this.$['loginToast'].open();
                        this.showToast('Error: ' + e);
                    },
                    conflict: (data) => {
                        this.showToast('The username is not available.')
                        this.$['username'].focus();
                    },
                    error: (e) => {
                        this.showToast(e.message);
                    },
                    failed: () => {
                        application.error("Failed to establish a connection to the authentication server.")
                    }
                }, this.username, this.password, this.email);
            } else {
                this.showToast('Password (repeat) does not match the password.');
                this.$['password-repeat'].focus();
            }
        }

        resetForm() {
            this.password = "";
            this["password-repeat"] = "";
            this.email = "";
            this.showLoginForm();
        }

        showLoginForm() {
            this.title = "Login";
            this.hideregisterform = true;
            this.hideloginform = false;
            this.$['username'].focus();
        }

        showRegisterForm() {
            this.title = "Register";
            this.hideregisterform = false;
            this.hideloginform = true;
            this.$['username'].focus();
        }

        showToast(text) {
            this.set('toasttext', text);
            this.$['loginToast'].open();
        }

        submit(e) {
            if (e.keyCode === 13) {
                if (!this.hideregisterform)
                    this.register();

                if (!this.hideloginform)
                    this.authenticate();
            }
        }
    }
    window.customElements.define(GameLogin.is, GameLogin);
</script>
